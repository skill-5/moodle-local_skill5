{"version":3,"file":"landing_handshake.min.js","sources":["../src/landing_handshake.js"],"sourcesContent":["/**\n * Landing page handshake module for Skill5 integration.\n *\n * @module     local_skill5/landing_handshake\n * @copyright  2025 Skill5\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Notification from 'core/notification';\n\n/**\n * Initialize the handshake listener for Skill5 iframe communication.\n *\n * @param {string} skill5Origin The origin URL of the Skill5 platform\n * @param {string} connectUrl The URL to connect.php\n * @param {string} connectionAssistantUrl The URL to connection_assistant.php\n */\nexport const init = (skill5Origin, connectUrl, connectionAssistantUrl) => {\n    window.console.log('[Moodle] Handshake listener is active. Skill5 Origin:', skill5Origin);\n\n    window.addEventListener('message', (event) => {\n        const message = event.data;\n\n        // Log all incoming messages for debugging\n        window.console.log('[Moodle] Received message from origin:', event.origin, 'Message:', message);\n\n        // Handle payment completion from popup (may come from Skill5 origin)\n        if (message && message.type === 'SKILL5_PAYMENT_COMPLETED') {\n            // Validate origin is from Skill5\n            if (event.origin === skill5Origin || event.origin.includes('skill5.com')) {\n                window.console.log('[Moodle] Payment completed, forwarding to iframe:', message.payload);\n                forwardMessageToIframe(message, skill5Origin);\n            } else {\n                window.console.warn('[Moodle] Payment message from unexpected origin:', event.origin);\n            }\n            return;\n        }\n\n        // For other messages, strict origin check\n        if (event.origin !== skill5Origin) {\n            // Only warn if it looks like a Skill5 message\n            if (message && message.type && message.type.startsWith('SKILL5_')) {\n                window.console.warn('[Moodle] Message from unexpected origin ignored:', event.origin);\n            }\n            return;\n        }\n\n        if (message && message.type) {\n            switch (message.type) {\n                case 'SKILL5_IFRAME_READY':\n                    window.console.log('[Moodle] Received SKILL5_IFRAME_READY. Sending acknowledgment...');\n                    event.source.postMessage({type: 'MOODLE_LISTENER_READY'}, event.origin);\n                    break;\n\n                case 'SKILL5_SEND_EMAIL':\n                    if (message.payload && message.payload.email) {\n                        handleEmailPayload(message.payload.email, connectUrl, connectionAssistantUrl);\n                    } else {\n                        window.console.error('[Moodle] Email payload is missing or invalid:', message.payload);\n                    }\n                    break;\n\n                case 'SKILL5_OPEN_STRIPE_CHECKOUT':\n                    if (message.payload && message.payload.url) {\n                        handleStripeCheckout(message.payload, skill5Origin);\n                    } else {\n                        window.console.error('[Moodle] Stripe checkout payload is missing or invalid:', message.payload);\n                    }\n                    break;\n            }\n        }\n    });\n};\n\n/**\n * Handle the email payload from Skill5 iframe.\n *\n * @param {string} adminEmail The admin email received from Skill5\n * @param {string} connectUrl The URL to connect.php\n * @param {string} connectionAssistantUrl The URL to connection_assistant.php\n */\nconst handleEmailPayload = (adminEmail, connectUrl, connectionAssistantUrl) => {\n    window.console.log('[Moodle] Received email payload:', adminEmail);\n    window.console.log('[Moodle] Calling connect.php via fetch...');\n\n    const url = `${connectUrl}?email=${encodeURIComponent(adminEmail)}`;\n\n    fetch(url, {\n        method: 'GET',\n        credentials: 'same-origin'\n    })\n    .then(response => {\n        window.console.log('[Moodle] Connect.php response received');\n        if (response.ok) {\n            window.console.log('[Moodle] Redirecting to connection_assistant.php');\n            window.location.href = connectionAssistantUrl;\n            return true;\n        }\n        window.console.error('[Moodle] Connect.php returned error:', response.status);\n        return Notification.alert(\n            'Connection Error',\n            'Connection failed. Please try again or contact support.',\n            'OK'\n        );\n    })\n    .catch(error => {\n        window.console.error('[Moodle] Error calling connect.php:', error);\n        return Notification.alert(\n            'Connection Error',\n            'Connection failed. Please try again or contact support.',\n            'OK'\n        );\n    });\n};\n\n/**\n * Forward message from popup to Skill5 iframe.\n *\n * @param {Object} message The message to forward\n * @param {string} targetOrigin The target origin for the message\n */\nconst forwardMessageToIframe = (message, targetOrigin) => {\n    const iframeSelectors = [\n        'iframe#skill5-shop-iframe-container',\n        'iframe#skill5-lti-catalog-iframe-container',\n        'iframe#skill5-iframe-container'\n    ];\n\n    window.console.log('[Moodle] Attempting to forward message to iframe. Target origin:', targetOrigin);\n    window.console.log('[Moodle] Looking for iframes:', iframeSelectors);\n\n    let iframeFound = false;\n\n    for (const selector of iframeSelectors) {\n        const skill5Iframe = document.querySelector(selector);\n        window.console.log('[Moodle] Checking selector:', selector, 'Found:', !!skill5Iframe);\n\n        if (skill5Iframe && skill5Iframe.contentWindow) {\n            try {\n                skill5Iframe.contentWindow.postMessage(message, targetOrigin);\n                window.console.log('[Moodle] Message forwarded to iframe successfully:', selector);\n                iframeFound = true;\n                break;\n            } catch (error) {\n                window.console.error('[Moodle] Error forwarding message to iframe:', error);\n            }\n        }\n    }\n\n    if (!iframeFound) {\n        window.console.error('[Moodle] Skill5 iframe not found. Cannot forward message.');\n        // List all iframes on the page for debugging\n        const allIframes = document.querySelectorAll('iframe');\n        window.console.log('[Moodle] All iframes on page:', allIframes.length);\n        allIframes.forEach((iframe, index) => {\n            window.console.log('[Moodle] Iframe', index, '- ID:', iframe.id, 'Src:', iframe.src);\n        });\n    }\n};\n\n/**\n * Handle Stripe checkout payload from Skill5 iframe.\n *\n * @param {Object} payload The checkout payload containing URL and session information\n * @param {string} skill5Origin The origin URL of the Skill5 platform\n */\nconst handleStripeCheckout = (payload, skill5Origin) => {\n    window.console.log('[Moodle] Received checkout request:', payload);\n\n    if (payload.url) {\n        const checkoutWindow = window.open(\n            payload.url,\n            'skill5_checkout',\n            'width=600,height=700,scrollbars=yes,resizable=yes'\n        );\n\n        if (checkoutWindow) {\n            checkoutWindow.focus();\n            window.console.log('[Moodle] Checkout window opened successfully');\n            showMoodleNotification('stripe_redirecting', 'info');\n\n            // Monitor when popup closes and notify iframe to check payment status\n            const checkPopupClosed = setInterval(() => {\n                if (checkoutWindow.closed) {\n                    clearInterval(checkPopupClosed);\n                    window.console.log('[Moodle] Checkout popup closed, notifying iframe to check status');\n\n                    // Send message to iframe that popup was closed - iframe should verify payment\n                    const message = {\n                        type: 'SKILL5_CHECKOUT_POPUP_CLOSED',\n                        payload: {\n                            sessionId: payload.sessionId,\n                            checkoutSessionId: payload.checkoutSessionId\n                        }\n                    };\n                    forwardMessageToIframe(message, skill5Origin);\n                }\n            }, 500);\n        } else {\n            window.console.warn('[Moodle] Popup may be blocked. Please allow popups for this site.');\n            showMoodleNotification('stripe_popup_blocked', 'warning');\n        }\n    } else {\n        window.console.error('[Moodle] Checkout URL not found in payload:', payload);\n        showMoodleNotification('stripe_payment_error', 'error');\n    }\n};\n\n/**\n * Show Moodle notification to the user.\n *\n * @param {string} messageKey The notification message key (language string identifier)\n * @param {string} type The notification type (info, success, warning, error)\n */\nconst showMoodleNotification = (messageKey, type = 'info') => {\n    let message = messageKey;\n\n    const messageMap = {\n        'stripe_redirecting': 'Redirecting to payment...',\n        'stripe_payment_error': 'Error processing payment. Please try again.',\n        'stripe_popup_blocked': 'Popup may be blocked. Please allow popups for this site.',\n        'stripe_checkout_opened': 'Payment window opened successfully.',\n        'stripe_checkout_failed': 'Failed to open payment window. Please try again.'\n    };\n\n    if (messageMap[messageKey]) {\n        message = messageMap[messageKey];\n    }\n\n    window.console.log(`[Moodle] [${type.toUpperCase()}] ${message}`);\n\n    if (typeof Notification !== 'undefined' && Notification.addNotification) {\n        Notification.addNotification({\n            message: message,\n            type: type\n        });\n    } else if (typeof M !== 'undefined' && M.util && M.util.add_notification) {\n        M.util.add_notification({\n            message: message,\n            type: type\n        });\n    } else {\n        window.console.log(`[Moodle] Notification: ${message}`);\n    }\n};\n"],"names":["skill5Origin","connectUrl","connectionAssistantUrl","window","console","log","addEventListener","event","message","data","origin","type","includes","payload","forwardMessageToIframe","warn","source","postMessage","email","handleEmailPayload","error","url","handleStripeCheckout","startsWith","adminEmail","encodeURIComponent","fetch","method","credentials","then","response","ok","location","href","status","Notification","alert","catch","targetOrigin","iframeSelectors","iframeFound","selector","skill5Iframe","document","querySelector","contentWindow","allIframes","querySelectorAll","length","forEach","iframe","index","id","src","checkoutWindow","open","focus","showMoodleNotification","checkPopupClosed","setInterval","closed","clearInterval","sessionId","checkoutSessionId","messageKey","messageMap","toUpperCase","addNotification","M","util","add_notification"],"mappings":"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"}