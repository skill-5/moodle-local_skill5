{"version":3,"file":"landing_handshake.min.js","sources":["../src/landing_handshake.js"],"sourcesContent":["/**\n * Landing page handshake module for Skill5 integration.\n *\n * @module     local_skill5/landing_handshake\n * @copyright  2025 Skill5\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Notification from 'core/notification';\n\n/**\n * Initialize the handshake listener for Skill5 iframe communication.\n *\n * @param {string} skill5Origin The origin URL of the Skill5 platform\n * @param {string} connectUrl The URL to connect.php\n * @param {string} connectionAssistantUrl The URL to connection_assistant.php\n */\nexport const init = (skill5Origin, connectUrl, connectionAssistantUrl) => {\n    window.console.log('[Moodle] Handshake listener is active.');\n\n    window.addEventListener('message', (event) => {\n        if (event.origin !== skill5Origin) {\n            window.console.warn('[Moodle] Message from unexpected origin ignored:', event.origin);\n            return;\n        }\n\n        const message = event.data;\n        window.console.log('[Moodle] Received message:', message);\n\n        if (message && message.type) {\n            switch (message.type) {\n                case 'SKILL5_IFRAME_READY':\n                    window.console.log('[Moodle] Received SKILL5_IFRAME_READY. Sending acknowledgment...');\n                    event.source.postMessage({type: 'MOODLE_LISTENER_READY'}, event.origin);\n                    break;\n\n                case 'SKILL5_SEND_EMAIL':\n                    if (message.payload && message.payload.email) {\n                        handleEmailPayload(message.payload.email, connectUrl, connectionAssistantUrl);\n                    } else {\n                        window.console.error('[Moodle] Email payload is missing or invalid:', message.payload);\n                    }\n                    break;\n            }\n        }\n    });\n};\n\n/**\n * Handle the email payload from Skill5 iframe.\n *\n * @param {string} adminEmail The admin email received from Skill5\n * @param {string} connectUrl The URL to connect.php\n * @param {string} connectionAssistantUrl The URL to connection_assistant.php\n */\nconst handleEmailPayload = (adminEmail, connectUrl, connectionAssistantUrl) => {\n    window.console.log('[Moodle] Received email payload:', adminEmail);\n    window.console.log('[Moodle] Calling connect.php via fetch...');\n\n    const url = `${connectUrl}?email=${encodeURIComponent(adminEmail)}`;\n\n    fetch(url, {\n        method: 'GET',\n        credentials: 'same-origin'\n    })\n    // eslint-disable-next-line promise/always-return\n    .then(response => {\n        window.console.log('[Moodle] Connect.php response received');\n        if (response.ok) {\n            window.console.log('[Moodle] Redirecting to connection_assistant.php');\n            window.location.href = connectionAssistantUrl;\n        } else {\n            window.console.error('[Moodle] Connect.php returned error:', response.status);\n            Notification.alert(\n                'Connection Error',\n                'Connection failed. Please try again or contact support.',\n                'OK'\n            );\n        }\n    })\n    .catch(error => {\n        window.console.error('[Moodle] Error calling connect.php:', error);\n        Notification.alert(\n            'Connection Error',\n            'Connection failed. Please try again or contact support.',\n            'OK'\n        );\n    });\n};\n"],"names":["skill5Origin","connectUrl","connectionAssistantUrl","window","console","log","addEventListener","event","origin","warn","message","data","type","source","postMessage","payload","email","handleEmailPayload","error","adminEmail","url","encodeURIComponent","fetch","method","credentials","then","response","ok","location","href","status","alert","catch"],"mappings":";;;;;;;oKAiBoB,CAACA,aAAcC,WAAYC,0BAC3CC,OAAOC,QAAQC,IAAI,0CAEnBF,OAAOG,iBAAiB,WAAYC,WAC5BA,MAAMC,SAAWR,yBACjBG,OAAOC,QAAQK,KAAK,mDAAoDF,MAAMC,cAI5EE,QAAUH,MAAMI,QACtBR,OAAOC,QAAQC,IAAI,6BAA8BK,SAE7CA,SAAWA,QAAQE,YACXF,QAAQE,UACP,sBACDT,OAAOC,QAAQC,IAAI,oEACnBE,MAAMM,OAAOC,YAAY,CAACF,KAAM,yBAA0BL,MAAMC,kBAG/D,oBACGE,QAAQK,SAAWL,QAAQK,QAAQC,MACnCC,mBAAmBP,QAAQK,QAAQC,MAAOf,WAAYC,wBAEtDC,OAAOC,QAAQc,MAAM,gDAAiDR,QAAQK,oBAehGE,mBAAqB,CAACE,WAAYlB,WAAYC,0BAChDC,OAAOC,QAAQC,IAAI,mCAAoCc,YACvDhB,OAAOC,QAAQC,IAAI,mDAEbe,cAASnB,6BAAoBoB,mBAAmBF,aAEtDG,MAAMF,IAAK,CACPG,OAAQ,MACRC,YAAa,gBAGhBC,MAAKC,WACFvB,OAAOC,QAAQC,IAAI,0CACfqB,SAASC,IACTxB,OAAOC,QAAQC,IAAI,oDACnBF,OAAOyB,SAASC,KAAO3B,yBAEvBC,OAAOC,QAAQc,MAAM,uCAAwCQ,SAASI,8BACzDC,MACT,mBACA,0DACA,UAIXC,OAAMd,QACHf,OAAOC,QAAQc,MAAM,sCAAuCA,6BAC/Ca,MACT,mBACA,0DACA"}